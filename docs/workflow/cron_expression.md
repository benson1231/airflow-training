# Airflow Cron 表達式手冊

**2025.10.20**

Airflow 的排程可使用 **cron 表達式** 控制任務執行頻率。其語法與 Linux crontab 幾乎相同，並支援一些方便的簡寫。以下為完整教學與常用範例。
[AWS整理：Systems Manager 的 Cron 和 Rate 運算式](https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/reference-cron-and-rate-expressions.html)

---

## 🧭 一、基本格式

標準 cron 表達式共有 **5 個欄位**：

```
┌───────── 分鐘 (0 - 59)
│ ┌─────── 小時 (0 - 23)
│ │ ┌───── 日期 (1 - 31)
│ │ │ ┌─── 月份 (1 - 12)
│ │ │ │ ┌─ 星期 (0 - 6，0=週日)
│ │ │ │ │
* * * * *
```

Airflow 會根據這個設定自動建立對應的 DAG Run。

---

## 🧮 二、常用範例速查表

| 表達式            | 說明            | 執行時間範例                      |
| -------------- | ------------- | --------------------------- |
| `* * * * *`    | 每分鐘           | 00:00、00:01、00:02 ...       |
| `0 * * * *`    | 每小時整點         | 01:00、02:00、03:00 ...       |
| `0 0 * * *`    | 每天 00:00      | 每天午夜                        |
| `0 9 * * *`    | 每天早上 9:00     | 09:00 每天                    |
| `0 9 * * 1-5`  | 每週一到五早上 9:00  | 工作日排程                       |
| `*/15 * * * *` | 每 15 分鐘       | 00:00、00:15、00:30、00:45 ... |
| `30 2 * * 1`   | 每週一凌晨 2:30    | 週一夜間任務                      |
| `0 8 1 * *`    | 每月 1 日早上 8:00 | 月初統計任務                      |
| `0 0 1 1 *`    | 每年 1 月 1 日    | 年報或清理作業                     |

---

## 🧩 三、特殊簡寫（Presets）

Airflow 支援以下簡寫形式：

| 簡寫                      | 等價於                | 說明           |
| ----------------------- | ------------------ | ------------ |
| `@once`                 | 立即執行一次             | DAG 啟動後執行一次  |
| `@hourly`               | `0 * * * *`        | 每小時          |
| `@daily`                | `0 0 * * *`        | 每天午夜         |
| `@weekly`               | `0 0 * * 0`        | 每週日午夜        |
| `@monthly`              | `0 0 1 * *`        | 每月 1 日午夜     |
| `@yearly` 或 `@annually` | `0 0 1 1 *`        | 每年 1 月 1 日午夜 |
| `@quarterly`            | `0 0 1 1,4,7,10 *` | 每季首日午夜       |

---

## ⚙️ 四、進階語法

| 語法        | 範例                | 意義                                     |
| --------- | ----------------- | -------------------------------------- |
| `*/N`     | `*/10`            | 每 N 單位執行一次（例：`*/10 * * * *` = 每 10 分鐘） |
| `A,B,C`   | `0 8,20 * * *`    | 8:00 與 20:00 各執行一次                     |
| `A-B`     | `0 9-17 * * *`    | 09:00～17:00 每小時一次                      |
| `A-B/N`   | `*/15 9-17 * * *` | 上班時間每 15 分鐘執行                          |
| `L` / `?` | 不支援               | Quartz 或 Linux 延伸語法（Airflow 不支援）       |

---

## 🕓 五、Airflow 特殊注意事項

### 1️⃣ 執行時間延後（延一週期）

Airflow 的 `execution_date` 代表「該週期的開始時間」，實際觸發點是下一個週期。
例：

* `schedule="0 0 * * *"`
* `execution_date=2025-10-19` → 實際觸發時間為 **2025-10-20 00:00**。

這樣設計是為了確保「昨日的資料」已經完整再執行報表或清理任務。

### 2️⃣ 時區控制

預設為 UTC，可使用 `pendulum` 指定：

```python
from pendulum import timezone
@dag(
    schedule="0 8 * * *",
    start_date=datetime(2025, 1, 1, tzinfo=timezone("Asia/Taipei")),
)
def demo():
    ...
```

或在 `airflow.cfg` 設定：

```
[core]
default_timezone = Asia/Taipei
```

### 3️⃣ CLI 測試排程

可透過以下指令預覽接下來的執行時間：

```bash
airflow dags next-execution <dag_id> --num 5
```

---

## 🧠 六、常見錯誤與除錯

| 問題        | 原因                                  | 解法                                  |
| --------- | ----------------------------------- | ----------------------------------- |
| DAG 沒觸發   | `start_date` 設在未來 / `catchup=False` | 調整 `start_date` 或手動 trigger         |
| 時間不符預期    | 忘記 Airflow 延後執行邏輯                   | 檢查 `execution_date` 與 log timestamp |
| 無法解析 cron | 使用 Quartz 語法（如 `?`, `L`）            | 改成標準五欄式 cron                        |

---

## 💡 七、與 Catchup 搭配

| 組合                                    | 行為                     |
| ------------------------------------- | ---------------------- |
| `schedule='0 0 * * *', catchup=True`  | 啟用 DAG 後自動補跑所有過去未執行的週期 |
| `schedule='0 0 * * *', catchup=False` | 只從當下時間開始排程，不補舊週期       |

---

## 🧭 八、常用工具

* [crontab.guru](https://crontab.guru) → 即時預覽 cron 時間
* [cronitor.io/tools/crontab](https://cronitor.io/tools/crontab) → 可視化排程產生器
* Airflow CLI → `airflow dags next-execution` 檢查排程結果

---

> ✅ **總結：** Airflow 的 cron 語法與 Linux 幾乎一致。熟悉五欄式結構、時間延後邏輯與 catchup 組合，就能完全掌握任務的排程行為。
